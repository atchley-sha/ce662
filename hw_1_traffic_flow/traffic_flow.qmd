---
title: "Homework: Traffic Flow"
subtitle: "2.4, 2.7, 3.1"
author: Hayden Atchley
date: today
date-format: "D MMMM YYYY"
number-sections: false
execute: 
  echo: false
format: pdf
---

```{r}
#| label: setup
#| include: false

library(tidyverse)
library(flextable)

hm <- function(vec){
  n <- length(vec)
  hm <- n / sum(1/vec)
  hm
}
```


# 2.4

```{r}
#| label: setup2-4

time <- 2 #minutes
speeds <- c(30, 45, 20, 36, 40) #kph
n = length(speeds)
```

Over the course of `r time` minutes, `r n` vehicles passed a point with speeds of `r speeds[1:(n-1)]` and `r speeds[n]` km/h.
The flow $q$ is given by $q = N/T$, where $N$ is the number of vehicles and $T$ the total time.
Therefore, the flow is $q = `r n`/`r time` = `r n/time`$ vehicles per minute or $q = `r n`/`r time` * 60 = `r n/time*60`$ vehicles per hour. 
The time-mean speed $v_t$ is the arithmetic mean of the spot speeds, or $v_t = `r mean(speeds) %>% round(2)`$ km/h.
The space-mean speed $v_s$ is the harmonic mean of the spot speeds, or $v_s = `r hm(speeds) %>% round(2)`$ km/h.
The time-mean speed is greater.

# 2.7

```{r}
#| label: setup2-7

lloop <- 6 #feet
lcar <- 15 #feet
ttime <- 10 #sec

loop <- tibble(
  on_sec = c(0,1,2,4,5,6,7,7,8),
  on_60 = c(0,32,32,22,6,9,4,57,43),
  off_sec = c(0,1,2,4,5,6,7,8,8),
  off_60 = c(12,45,45,35,19,22,19,9,53),
  on_time = on_sec + on_60/60,
  off_time = off_sec + off_60/60) %>% 
  transmute(
    veh_num = 1:nrow(.),
    on_time,
    off_time,
    time = off_time - on_time)

ncar <- nrow(loop)
otime <- sum(loop$time)
```

@fig-loop-detector shows the output of a `r lloop`-foot long loop detector.
The $x$-axis indicates seconds, and the numbers above each bump indicate the on and off times in 1/60 of a second (e.g. `32â€“45` indicates that the detector turned on at $32/60$ seconds and off at $45/60$ seconds).

```{r}
#| label: fig-loop-detector
#| fig-cap: Loop detector on/off data.

knitr::include_graphics("images/2-7_loop_detector.png")
```

(a) There were `r ncar` vehicles over the `r ttime`-second observation window, so the hourly flow rate is $`r ncar`/`r ttime` * 3600 = `r (ncar/ttime*3600) %>% round()`$ vehicles per hour.

(b) Occupancy is defined as the ratio of detector "on" time to the total observation time: $o = \frac{\sum_{i=1}^N{(\xi_i = t_i^\text{OFF}-t_i^\text{ON})}}{T}$.
@tbl-vehicle-times gives the on and off times of each vehicle (converted to seconds), and the total time each vehicle triggered the detector.
From this, the occupancy is determined to be $\frac{\sum{\xi_i} = `r otime %>% round(2)`}{T = 10} = `r (otime/10) %>% round(3)`$

```{r}
#| label: tbl-vehicle-times
#| tbl-cap: Vehicle Detector Times

loop %>%
  round(2) %>%
  flextable() %>%
  set_header_labels(
    veh_num = "Vehicle\nNumber",
    on_time = "Detector\nOn Time (s)",
    off_time = "Detector\nOff Time (s)",
    time = "Activated\nTime (s)") %>%
  autofit() %>% 
  align(align = "c", part = "a")
```

```{r}
speeds <- loop %>% 
  transmute(
    veh_num,
    time,
    loop_length = lloop,
    car_length = lcar,
    speed = (loop_length + car_length) / time * 3600/5280 #ft/s to mph
  )

tms <- mean(speeds$speed)
sms <- hm(speeds$speed)
```

(c) The speed is given by the length of the detector and vehicle divided by the time the detector was active, i.e. $\dot x = \frac{l_{car} + l_{loop}}{\xi}$.
@tbl-speeds shows this information.
From here, $v_t$ and $v_s$ are calculated as before, so $v_t = tms %>% round(2)$ and $v_s = sms %>% round(2)$

```{r}
#| label: tbl-speeds
#| tbl-cap: speeds

speeds %>% 
  round(2) %>% 
  flextable() %>% 
  set_header_labels(
    veh_num = "Vehicle\nNumber",
    time = "Activated\nTime (s)",
    loop_length = "Detector\nLength (ft)",
    car_length = "Vehicle\nLength (ft)",
    speed = "Vehicle\nSpeed (mph)"
  ) %>%
  colformat_double(j = "speed", digits = 1) %>% 
  autofit() %>% 
  align(align = "c", part = "a")
```


